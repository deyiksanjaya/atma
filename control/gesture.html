<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Photos">
    <link rel="apple-touch-icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=Icon';">
    <link rel="icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/000000/FFFFFF?text=Icon';">

    <title>Atma by Heri Sanjaya</title>
    <!-- Google Fonts untuk nuansa koran antik -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:ital,wght@0,400;0,600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            color: #000; /* Default text color */
            overflow: hidden; /* Prevent scrolling */
            position: fixed; /* Prevent pull-to-refresh */
            width: 100%;
            height: 100%;
            margin: 0;
        }
        /* Hide app wrapper initially to prevent flash of content */
        #app-wrapper {
            display: none;
        }
        #app-wrapper.unlocked {
            display: block;
        }
        /* Main container for the solid black background */
        #app-container {
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* The gallery frame, an overlay on the black background */
        #display-area {
            position: relative;
            width: 100vw;
            height: 100vw;
            max-height: 100vh;
            box-sizing: border-box;
            overflow: hidden; /* Crucial for gallery effect */
        }
        #slide-container {
            height: 100%;
            display: flex;
            gap: 20px;
        }
        /* The transparent container for each photo */
        .slide {
            height: 100%;
            width: 100vw;
            flex-shrink: 0; /* Prevent slides from shrinking */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* The actual white "photo" content */
        .slide-content {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px; /* Inner padding for text */
            box-sizing: border-box;
        }
        /* Style for the history overlay */
        #history-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #fff;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: left;
            display: none;
            z-index: 20;
        }
        #history-overlay.show {
            display: block;
        }
        /* Utilitas font kustom untuk modal */
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-lora { font-family: 'Lora', serif; }
        
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body id="touchArea" class="bg-black">

    <!-- License Modal -->
    <div id="license-modal" class="fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50 p-4" style="display: none;">
        <div class="font-lora bg-[#fdfaf3] rounded-sm p-6 w-full max-w-sm text-[#1a1a1a] border-2 border-black shadow-2xl text-center">
            <h2 class="font-playfair text-2xl mb-4 border-b-2 border-gray-400 pb-2 uppercase">License Activation</h2>
            <p class="mb-6">Please enter your license key to unlock the app.</p>
            <input type="text" id="license-key-input" placeholder="ABC-123-XYZ" class="w-full p-3 text-center border-2 border-black rounded-sm mb-4 bg-white text-lg tracking-widest">
            <button id="verify-license-btn" class="font-playfair w-full bg-black hover:bg-gray-800 text-[#fdfaf3] p-3 rounded-sm uppercase tracking-wider transition-colors duration-300 flex items-center justify-center">
                <span>Activate</span>
            </button>
            <p id="license-error" class="text-red-600 mt-4 text-sm h-5"></p>
        </div>
    </div>

    <!-- App Wrapper -->
    <div id="app-wrapper">
        <!-- One-time Settings Notification -->
        <div id="settings-toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 w-11/12 max-w-sm bg-[#fdfaf3] text-[#1a1a1a] p-3 rounded-sm shadow-lg z-30 flex items-center justify-between font-lora border-2 border-black">
            <p>Tip: Two-finger swipe down to open settings.</p>
            <button id="close-toast-btn" class="text-2xl font-bold leading-none pl-4">&times;</button>
        </div>

        <!-- Main container with solid black background -->
        <div id="app-container">
            <div id="display-area">
                <div id="slide-container"></div>
            </div>
        </div>

        <!-- History overlay -->
        <div id="history-overlay"></div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-50 p-4">
            <div class="font-lora bg-[#fdfaf3] rounded-sm p-6 w-11/12 max-w-sm text-[#1a1a1a] border-2 border-black shadow-2xl">
                <h2 id="settings-title" class="font-playfair text-2xl mb-4 border-b-2 border-gray-400 pb-2 uppercase"></h2>
                <div class="my-6">
                    <label id="language-label" class="font-playfair block mb-2 font-bold"></label>
                    <div class="flex space-x-4">
                        <button id="lang-id" class="flex-1 p-2 rounded-sm border-2"></button>
                        <button id="lang-eng" class="flex-1 p-2 rounded-sm border-2"></button>
                    </div>
                </div>
                
                <a href="instructions.html" id="read-instructions-btn" class="font-playfair w-full block bg-gray-700 hover:bg-gray-900 text-[#fdfaf3] p-2 rounded-sm text-center uppercase tracking-wider transition-colors duration-300 mt-6"></a>
                
                <button id="close-settings" class="font-playfair w-full bg-black hover:bg-gray-800 text-[#fdfaf3] p-2 rounded-sm uppercase tracking-wider transition-colors duration-300 mt-2"></button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // --- DOM ELEMENT REFERENCES ---
        const licenseModal = document.getElementById('license-modal');
        const licenseKeyInput = document.getElementById('license-key-input');
        const verifyLicenseBtn = document.getElementById('verify-license-btn');
        const licenseError = document.getElementById('license-error');
        const appWrapper = document.getElementById('app-wrapper');
        const settingsToast = document.getElementById('settings-toast');
        const closeToastBtn = document.getElementById('close-toast-btn');
        const displayArea = document.getElementById('display-area');
        const slideContainer = document.getElementById('slide-container');
        const touchArea = document.getElementById('touchArea');
        const historyOverlayElement = document.getElementById('history-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const settingsTitle = document.getElementById('settings-title');
        const languageLabel = document.getElementById('language-label');
        const langIdButton = document.getElementById('lang-id');
        const langEngButton = document.getElementById('lang-eng');
        const closeSettingsButton = document.getElementById('close-settings');
        const readInstructionsButton = document.getElementById('read-instructions-btn');

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCFDxFe2PnyxaLRb7VctQSHhQh7ZKoSDaU",
            authDomain: "atmamagicbyheri.firebaseapp.com",
            projectId: "atmamagicbyheri",
            storageBucket: "atmamagicbyheri.firebasestorage.app",
            messagingSenderId: "672288947327",
            appId: "1:672288947327:web:4ee5d222045bfaf6ed934a"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LANGUAGE & TRANSLATIONS ---
        const translations = {
            id: {
                victimName: 'Nama Korban:',
                crimeScene: 'Lokasi Kejadian:',
                weapon: 'Alat yang Dipakai:',
                noHistory: 'Tidak ada riwayat gerakan.',
                settingsTitle: 'Pengaturan',
                languageLabel: 'Bahasa:',
                closeButton: 'Tutup',
                readInstructions: 'Baca Instruksi',
                langId: 'Indonesia',
                langEng: 'English'
            },
            eng: {
                victimName: "Victim's Name:",
                crimeScene: 'Crime Scene:',
                weapon: 'Weapon Used:',
                noHistory: 'No gesture history.',
                settingsTitle: 'Settings',
                languageLabel: 'Language:',
                closeButton: 'Close',
                readInstructions: 'Read Instructions',
                langId: 'Indonesia',
                langEng: 'English'
            }
        };

        // --- APP CONTENT ---
        const displayContent = {
            id: [
                { title: translations.id.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.id.crimeScene, items: ['Kamar lantai dua', 'Loteng', 'Gudang belakang', 'Ruang bawah tanah', 'Lorong dekat dapur'] },
                { title: translations.id.weapon, items: ['Pisau', 'Palu', 'Gunting', 'Linggis', 'Batang besi'] }
            ],
            eng: [
                { title: translations.eng.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.eng.crimeScene, items: ['Second floor room', 'Attic', 'Back warehouse', 'Basement', 'Hallway near kitchen'] },
                { title: translations.eng.weapon, items: ['Knife', 'Hammer', 'Scissors', 'Crowbar', 'Iron rod'] }
            ]
        };
        const gestureTexts = [
            { 'Up': 'Eleanor', 'Right': 'Abigail', 'Down': 'Lillian', 'Left': 'Margaret', 'Tap': 'Beatrice' },
            { 'Up': 'kamar lantai dua', 'Right': 'loteng', 'Down': 'gudang belakang', 'Left': 'ruang bawah tanah', 'Tap': 'lorong dekat dapur' },
            { 'Up': 'pisau', 'Right': 'palu', 'Down': 'gunting', 'Left': 'linggis', 'Tap': 'batang besi' }
        ];

        // --- STATE & CONSTANTS ---
        let startX = 0, startY = 0, gestureCount = 0, currentSlideIndex = 0;
        const gestureSequence = [], gestureTextHistory = [];
        let isSessionActive = true, tapCount = 0, lastTapTime = 0, tapHoldTimeout = null;
        let currentLanguage = 'eng', twoFingerTrack = null, multiTouchJustEnded = false;
        let startArea = null, isDragging = false, initialTranslate = 0;
        const SWIPE_THRESHOLD = 50, TAP_THRESHOLD = 10, DOUBLE_TAP_TIMEOUT = 300;
        const TAP_HOLD_DURATION = 500, TOTAL_SLIDES = 4, SLIDE_GAP = 20;
        const gridToGesture = { 'a': 'A', 'b': 'B', 'c': 'C', 'd': 'D', 'e': 'E' };
        const gestureToCode = { 'A': 'Fl', 'B': 'uC', 'C': 'zW', 'D': 'Xy', 'E': 'Qr' };
        const gestureToTextKey = { 'A': 'Up', 'B': 'Right', 'C': 'Left', 'D': 'Down', 'E': 'Tap' };

        // --- LICENSE LOGIC ---
        const showLicenseModal = () => {
            licenseModal.style.display = 'flex';
            appWrapper.classList.remove('unlocked');
        };

        const showSettingsToastIfNeeded = () => {
            if (!localStorage.getItem('atmaSettingsToastShown')) {
                settingsToast.classList.remove('hidden');
                localStorage.setItem('atmaSettingsToastShown', 'true');
            }
        };

        const unlockApp = () => {
            licenseModal.style.display = 'none';
            appWrapper.classList.add('unlocked');
            setLanguage('eng');
            showSettingsToastIfNeeded();
        };
        
        const setButtonLoading = (isLoading) => {
            const buttonContent = verifyLicenseBtn.querySelector('span');
            if (isLoading) {
                buttonContent.style.display = 'none';
                if (!verifyLicenseBtn.querySelector('.spinner')) {
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner';
                    verifyLicenseBtn.appendChild(spinner);
                }
            } else {
                buttonContent.style.display = 'inline';
                const spinner = verifyLicenseBtn.querySelector('.spinner');
                if (spinner) {
                    spinner.remove();
                }
            }
        };

        const verifyLicense = async () => {
            const key = licenseKeyInput.value.trim().toUpperCase();
            if (!key) {
                licenseError.textContent = 'Please enter a license key.';
                return;
            }
            setButtonLoading(true);
            licenseError.textContent = '';
            try {
                const availableLicenseRef = doc(db, 'availableLicenses', key);
                const licenseSnap = await getDoc(availableLicenseRef);
                if (licenseSnap.exists() && licenseSnap.data().status === 'available') {
                    const originalData = licenseSnap.data();
                    const activatedLicenseRef = doc(db, 'activatedLicenses', key);
                    await setDoc(activatedLicenseRef, {
                        ...originalData,
                        status: 'used',
                        uid: auth.currentUser.uid,
                        claimedAt: serverTimestamp()
                    });
                    await deleteDoc(availableLicenseRef);
                    const licenseData = {
                        key: key,
                        lastValidated: new Date().getTime()
                    };
                    localStorage.setItem('atmaLicense', JSON.stringify(licenseData));
                    unlockApp();
                } else {
                    licenseError.textContent = 'Invalid or already used license key.';
                }
            } catch (error) {
                console.error("Error verifying license:", error);
                licenseError.textContent = 'Verification failed. Please try again.';
            } finally {
                setButtonLoading(false);
            }
        };

        const checkLicenseOnLoad = async () => {
            const licenseDataString = localStorage.getItem('atmaLicense');
            if (!licenseDataString) {
                showLicenseModal();
                return;
            }

            const licenseData = JSON.parse(licenseDataString);
            const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;
            const isExpired = (new Date().getTime() - licenseData.lastValidated) > sevenDaysInMillis;

            if (!isExpired) {
                unlockApp();
                return;
            }
            
            // Re-verify if older than 7 days
            try {
                const licenseRef = doc(db, 'activatedLicenses', licenseData.key);
                const licenseSnap = await getDoc(licenseRef);
                if (licenseSnap.exists() && licenseSnap.data().uid === auth.currentUser.uid) {
                    licenseData.lastValidated = new Date().getTime();
                    localStorage.setItem('atmaLicense', JSON.stringify(licenseData));
                    unlockApp();
                } else {
                    localStorage.removeItem('atmaLicense');
                    showLicenseModal();
                    licenseError.textContent = 'License re-validation failed. Please enter again.';
                }
            } catch (error) {
                 console.error("Error re-verifying license:", error);
                 unlockApp();
            }
        };
        
        // --- INITIALIZATION ---
        window.onload = async () => {
            try {
                await signInAnonymously(auth);
                await checkLicenseOnLoad();
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                showLicenseModal();
                licenseError.textContent = "Could not connect to authentication service.";
            }
        };

        // --- EVENT LISTENERS ---
        verifyLicenseBtn.addEventListener('click', verifyLicense);
        licenseKeyInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') verifyLicense();
        });
        closeToastBtn.addEventListener('click', () => {
            settingsToast.classList.add('hidden');
        });
        window.onresize = () => {
            if (appWrapper.classList.contains('unlocked')) {
                animateToSlide(currentSlideIndex);
            }
        };
        
        // --- APP CORE FUNCTIONS ---
        function setLanguage(lang) {
            currentLanguage = lang;
            const t = translations[currentLanguage];
            settingsTitle.textContent = t.settingsTitle;
            languageLabel.textContent = t.languageLabel;
            closeSettingsButton.textContent = t.closeButton;
            readInstructionsButton.textContent = t.readInstructions;
            langIdButton.textContent = t.langId;
            langEngButton.textContent = t.langEng;
            if (lang === 'id') {
                langIdButton.className = 'flex-1 p-2 rounded-sm border-2 border-black bg-black text-[#fdfaf3]';
                langEngButton.className = 'flex-1 p-2 rounded-sm border-2 border-black bg-transparent text-black';
            } else {
                langEngButton.className = 'flex-1 p-2 rounded-sm border-2 border-black bg-black text-[#fdfaf3]';
                langIdButton.className = 'flex-1 p-2 rounded-sm border-2 border-black bg-transparent text-black';
            }
            resetApp();
        }

        function createSlide(slideIndex) {
            const slide = document.createElement('div');
            slide.className = 'slide';
            const slideContent = document.createElement('div');
            slideContent.className = 'slide-content';
            if (slideIndex < 3) {
                const contentData = displayContent[currentLanguage][slideIndex];
                const listItems = contentData.items.map(item => `<li class="ml-4 text-xl">â€¢ ${item}</li>`).join('');
                slideContent.innerHTML = `
                    <div class="text-left w-full h-full flex flex-col justify-center">
                        <h2 class="text-3xl font-bold mb-4">${contentData.title}</h2>
                        <ul class="list-none space-y-2">${listItems}</ul>
                    </div>`;
            } else {
                slideContent.innerHTML = '';
            }
            slide.appendChild(slideContent);
            return slide;
        }
        
        function animateToSlide(slideIndex) {
            slideContainer.style.transition = 'transform 0.4s ease-in-out';
            const slideWidth = displayArea.getBoundingClientRect().width;
            const totalTranslation = (slideWidth * slideIndex) + (SLIDE_GAP * slideIndex);
            slideContainer.style.transform = `translateX(-${totalTranslation}px)`;
            currentSlideIndex = slideIndex;
        }

        function setupInitialView() {
            slideContainer.innerHTML = '';
            for(let i = 0; i < TOTAL_SLIDES; i++) {
                slideContainer.appendChild(createSlide(i));
            }
            animateToSlide(0);
        }
        
        function resetApp() {
            gestureCount = 0;
            currentSlideIndex = 0;
            gestureSequence.length = 0;
            gestureTextHistory.length = 0;
            isSessionActive = true;
            tapCount = 0;
            lastTapTime = 0;
            setupInitialView();
        }
        
        function showHistoryOverlay() {
            if (gestureTextHistory.length === 0) {
                historyOverlayElement.innerHTML = `<ul><li>${translations[currentLanguage].noHistory}</li></ul>`;
            } else {
                const historyHtml = `<ul>${gestureTextHistory.map(item => `<li class="mb-1">${item}</li>`).join('')}</ul>`;
                historyOverlayElement.innerHTML = historyHtml;
            }
            historyOverlayElement.classList.add('show');
        }

        function hideHistoryOverlay() {
            historyOverlayElement.classList.remove('show');
        }

        function getGridArea(clientX, clientY) {
            const rect = displayArea.getBoundingClientRect();
            if (clientX < rect.left || clientX > rect.right || clientY < rect.top || clientY > rect.bottom) return null;
            const localX = clientX - rect.left;
            const localY = clientY - rect.top;
            const centerXStart = rect.width * 0.25, centerXEnd = rect.width * 0.75;
            const centerYStart = rect.height * 0.25, centerYEnd = rect.height * 0.75;
            if (localX > centerXStart && localX < centerXEnd && localY > centerYStart && localY < centerYEnd) return 'e';
            const midX = rect.width / 2, midY = rect.height / 2;
            if (localX < midX && localY < midY) return 'a';
            if (localX >= midX && localY < midY) return 'b';
            if (localX < midX && localY >= midY) return 'c';
            if (localX >= midX && localY >= midY) return 'd';
            return null;
        }

        function openSettingsModal() { settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); }

        touchArea.addEventListener('touchstart', (e) => {
            if (!appWrapper.classList.contains('unlocked') || e.target.closest('#settings-modal')) return;
            e.preventDefault();
            if (e.touches.length === 2) {
                twoFingerTrack = { startY1: e.touches[0].clientY, startY2: e.touches[1].clientY, swiped: false };
                return; 
            }
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            if (isSessionActive) {
                startArea = getGridArea(startX, startY);
            } else {
                isDragging = false;
                slideContainer.style.transition = 'none';
                const slideWidth = displayArea.getBoundingClientRect().width;
                initialTranslate = -((slideWidth * currentSlideIndex) + (SLIDE_GAP * currentSlideIndex));
                tapHoldTimeout = setTimeout(showHistoryOverlay, TAP_HOLD_DURATION);
            }
        }, { passive: false });

        touchArea.addEventListener('touchmove', (e) => {
            if (!appWrapper.classList.contains('unlocked') || e.target.closest('#settings-modal')) return;
            e.preventDefault();
            if (twoFingerTrack && e.touches.length === 2 && !twoFingerTrack.swiped) {
                const deltaY1 = e.touches[0].clientY - twoFingerTrack.startY1;
                const deltaY2 = e.touches[1].clientY - twoFingerTrack.startY2;
                if (deltaY1 > SWIPE_THRESHOLD && deltaY2 > SWIPE_THRESHOLD) {
                    openSettingsModal();
                    twoFingerTrack.swiped = true; 
                }
                return;
            }
            if (!isSessionActive) {
                const currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                if (Math.abs(diffX) > TAP_THRESHOLD) {
                    isDragging = true;
                    if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
                }
                if (isDragging) {
                    slideContainer.style.transform = `translateX(${initialTranslate + diffX}px)`;
                }
            }
        }, { passive: false });

        touchArea.addEventListener('touchend', (e) => {
            if (!appWrapper.classList.contains('unlocked') || e.target.closest('#settings-modal')) return;
            if (twoFingerTrack) {
                twoFingerTrack = null;
                multiTouchJustEnded = true;
                setTimeout(() => { multiTouchJustEnded = false; }, 50);
                return;
            }
            if (multiTouchJustEnded) return;
            if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
            hideHistoryOverlay();
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = endX - startX;
            const absDiffX = Math.abs(diffX);
            const absDiffY = Math.abs(endY - startY);
            if (!isSessionActive) {
                const isTap = absDiffX < TAP_THRESHOLD && absDiffY < TAP_THRESHOLD;
                if (isTap) {
                    const currentTime = new Date().getTime();
                    tapCount = (currentTime - lastTapTime < DOUBLE_TAP_TIMEOUT) ? tapCount + 1 : 1;
                    lastTapTime = currentTime;
                    if (tapCount === 3) resetApp();
                } else if (absDiffX > SWIPE_THRESHOLD) {
                    if (diffX < 0 && currentSlideIndex < TOTAL_SLIDES - 1) {
                        currentSlideIndex++;
                    } else if (diffX > 0 && currentSlideIndex > 0) {
                        currentSlideIndex--;
                    }
                }
                animateToSlide(currentSlideIndex);
                isDragging = false;
                return;
            }
            let detectedGesture = '';
            if (startArea && diffX < -SWIPE_THRESHOLD && absDiffX > absDiffY) {
                detectedGesture = gridToGesture[startArea];
            }
            startArea = null;
            if (!detectedGesture) return;
            const gestureCode = gestureToCode[detectedGesture];
            if (gestureCode) {
                gestureSequence.push(gestureCode);
                const textKey = gestureToTextKey[detectedGesture];
                const textToShow = gestureTexts[gestureCount][textKey];
                if (textToShow) gestureTextHistory.push(textToShow);
                gestureCount++;
                animateToSlide(gestureCount);
                if (gestureCount >= 3) {
                    isSessionActive = false;
                    const lastSlideContent = slideContainer.children[3].querySelector('.slide-content');
                    lastSlideContent.innerHTML = '';
                    const finalUrl = `https://www.cnid.my.id/smith-family.html?id=${gestureSequence.join('')}&lang=${currentLanguage}`;
                    const qrCodeSize = Math.min(lastSlideContent.offsetWidth, lastSlideContent.offsetHeight) * 0.9;
                     new QRCode(lastSlideContent, {
                        text: finalUrl,
                        width: qrCodeSize,
                        height: qrCodeSize,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }
        });

        langIdButton.addEventListener('click', () => setLanguage('id'));
        langEngButton.addEventListener('click', () => setLanguage('eng'));
        closeSettingsButton.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

    </script>
</body>
</html>
