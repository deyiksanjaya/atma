<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#E1F5FE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AtmaGesture">
    <link rel="apple-touch-icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=Icon';">
    <link rel="icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/000000/FFFFFF?text=Icon';">

    <title>Gesture Encoder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #000; /* Black background */
            color: #000; /* Default text color for content inside the white box */
            overflow: hidden; /* Prevent scrolling */
            position: fixed; /* Prevent pull-to-refresh */
            width: 100%;
            height: 100%;
        }
        .touch-area {
            /* Make the touch area cover the full screen */
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* Style for the display area (for text and QR code) */
        #display-area {
            position: relative;
            width: 100vw;
            height: 100vw;
            max-width: 100vh;
            max-height: 100vh;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #display-area img {
            max-width: 100%;
            height: auto;
        }
        /* Style for the history overlay */
        #history-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #fff;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: left;
            display: none;
            z-index: 20;
        }
        #history-overlay.show {
            display: block;
        }
    </style>
</head>
<body id="touchArea" class="touch-area">
    <!-- Container for the Display Content (Text and QR Code) -->
    <div id="display-area"></div>
    <!-- History overlay -->
    <div id="history-overlay"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm text-black">
            <h2 id="settings-title" class="text-2xl font-bold mb-4"></h2>
            <div class="mb-4">
                <label id="language-label" class="block mb-2 font-medium"></label>
                <div class="flex space-x-2">
                    <button id="lang-id" class="flex-1 p-2 rounded-md border-2"></button>
                    <button id="lang-eng" class="flex-1 p-2 rounded-md border-2"></button>
                </div>
            </div>
            <button id="close-settings" class="w-full bg-gray-500 text-white p-2 rounded-md mt-4"></button>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT REFERENCES ---
        const displayArea = document.getElementById('display-area');
        const touchArea = document.getElementById('touchArea');
        const historyOverlayElement = document.getElementById('history-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const settingsTitle = document.getElementById('settings-title');
        const languageLabel = document.getElementById('language-label');
        const langIdButton = document.getElementById('lang-id');
        const langEngButton = document.getElementById('lang-eng');
        const closeSettingsButton = document.getElementById('close-settings');

        // --- LANGUAGE & TRANSLATIONS ---
        const translations = {
            id: {
                victimName: 'Nama Korban:',
                crimeScene: 'Lokasi Kejadian:',
                weapon: 'Alat yang Dipakai:',
                noHistory: 'Tidak ada riwayat gerakan.',
                settingsTitle: 'Pengaturan',
                languageLabel: 'Bahasa:',
                closeButton: 'Tutup',
                langId: 'Indonesia',
                langEng: 'English'
            },
            eng: {
                victimName: "Victim's Name:",
                crimeScene: 'Crime Scene:',
                weapon: 'Weapon Used:',
                noHistory: 'No gesture history.',
                settingsTitle: 'Settings',
                languageLabel: 'Language:',
                closeButton: 'Close',
                langId: 'Indonesia',
                langEng: 'English'
            }
        };

        const displayContent = {
            id: [
                { title: translations.id.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.id.crimeScene, items: ['Kamar lantai dua', 'Loteng', 'Gudang belakang', 'Ruang bawah tanah', 'Lorong dekat dapur'] },
                { title: translations.id.weapon, items: ['Pisau', 'Palu', 'Gunting', 'Linggis', 'Batang besi'] }
            ],
            eng: [
                { title: translations.eng.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.eng.crimeScene, items: ['Second floor room', 'Attic', 'Back warehouse', 'Basement', 'Hallway near kitchen'] },
                { title: translations.eng.weapon, items: ['Knife', 'Hammer', 'Scissors', 'Crowbar', 'Iron rod'] }
            ]
        };
        
        const gestureTexts = [
            { 'Up': 'Eleanor', 'Right': 'Abigail', 'Down': 'Lillian', 'Left': 'Margaret', 'Tap': 'Beatrice' },
            { 'Up': 'kamar lantai dua', 'Right': 'loteng', 'Down': 'gudang belakang', 'Left': 'ruang bawah tanah', 'Tap': 'lorong dekat dapur' },
            { 'Up': 'pisau', 'Right': 'palu', 'Down': 'gunting', 'Left': 'linggis', 'Tap': 'batang besi' }
        ];

        // --- STATE VARIABLES ---
        let startX = 0, startY = 0, endX = 0, endY = 0;
        let gestureCount = 0;
        const gestureSequence = [];
        let gestureTextHistory = [];
        let isSessionActive = true;
        let tapCount = 0;
        let lastTapTime = 0;
        let tapHoldTimeout = null;
        let currentLanguage = 'id';
        let twoFingerTrack = null;
        let multiTouchJustEnded = false; // *** BUG FIX: Flag to prevent stray touch events ***

        // --- CONSTANTS ---
        const SWIPE_THRESHOLD = 50; // Min pixels for a swipe
        const TAP_THRESHOLD = 10;   // Max pixels for a tap
        const DOUBLE_TAP_TIMEOUT = 300; // ms
        const TAP_HOLD_DURATION = 500; // ms

        // --- CORE FUNCTIONS ---

        function setLanguage(lang) {
            currentLanguage = lang;
            const t = translations[currentLanguage];
            settingsTitle.textContent = t.settingsTitle;
            languageLabel.textContent = t.languageLabel;
            closeSettingsButton.textContent = t.closeButton;
            langIdButton.textContent = t.langId;
            langEngButton.textContent = t.langEng;
            if (lang === 'id') {
                langIdButton.className = 'flex-1 p-2 rounded-md border-2 border-blue-500 bg-blue-500 text-white';
                langEngButton.className = 'flex-1 p-2 rounded-md border-2 border-gray-300 bg-white text-black';
            } else {
                langIdButton.className = 'flex-1 p-2 rounded-md border-2 border-gray-300 bg-white text-black';
                langEngButton.className = 'flex-1 p-2 rounded-md border-2 border-blue-500 bg-blue-500 text-white';
            }
            updateDisplay();
        }

        function updateDisplay() {
            displayArea.innerHTML = ''; 
            if (gestureCount < 3) {
                const content = displayContent[currentLanguage][gestureCount];
                const listItems = content.items.map(item => `<li class="ml-4 text-xl">â€¢ ${item}</li>`).join('');
                displayArea.innerHTML = `
                    <div class="p-4 text-left w-full h-full flex flex-col justify-center">
                        <h2 class="text-3xl font-bold mb-4">${content.title}</h2>
                        <ul class="list-none space-y-2">${listItems}</ul>
                    </div>
                `;
            } else {
                isSessionActive = false; 
                const compiledCode = gestureSequence.join('');
                const finalUrl = `https://www.cnid.my.id/smith-family.html?id=${compiledCode}&lang=${currentLanguage}`;
                generateQRCode(finalUrl);
            }
        }

        function generateQRCode(url) {
            displayArea.innerHTML = ''; 
            const qrCodeSize = Math.min(displayArea.offsetWidth, displayArea.offsetHeight) - 40;
            new QRCode(displayArea, {
                text: url,
                width: qrCodeSize,
                height: qrCodeSize,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function showHistoryOverlay() {
            if (gestureTextHistory.length === 0) {
                historyOverlayElement.innerHTML = `<ul><li>${translations[currentLanguage].noHistory}</li></ul>`;
            } else {
                const historyHtml = `<ul>${gestureTextHistory.map(item => `<li class="mb-1">${item}</li>`).join('')}</ul>`;
                historyOverlayElement.innerHTML = historyHtml;
            }
            historyOverlayElement.classList.add('show');
        }

        function hideHistoryOverlay() {
            historyOverlayElement.classList.remove('show');
        }
        
        function resetApp() {
            gestureCount = 0;
            gestureSequence.length = 0;
            gestureTextHistory.length = 0;
            isSessionActive = true;
            tapCount = 0;
            lastTapTime = 0;
            updateDisplay(); 
        }

        // --- MODAL FUNCTIONS ---
        function openSettingsModal() {
            settingsModal.classList.remove('hidden');
        }
        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---

        touchArea.addEventListener('touchstart', (e) => {
            if (e.target.closest('#settings-modal')) {
                return;
            }
            e.preventDefault();
            
            if (e.touches.length === 2) {
                twoFingerTrack = {
                    startY1: e.touches[0].clientY,
                    startY2: e.touches[1].clientY,
                    swiped: false
                };
                return; 
            }

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;

            if (!isSessionActive) {
                tapHoldTimeout = setTimeout(() => {
                    showHistoryOverlay();
                }, TAP_HOLD_DURATION);
            }
        }, { passive: false });

        touchArea.addEventListener('touchmove', (e) => {
            if (e.target.closest('#settings-modal')) {
                return;
            }
            e.preventDefault();
            if (twoFingerTrack && e.touches.length === 2 && !twoFingerTrack.swiped) {
                const deltaY1 = e.touches[0].clientY - twoFingerTrack.startY1;
                const deltaY2 = e.touches[1].clientY - twoFingerTrack.startY2;

                if (deltaY1 > SWIPE_THRESHOLD && deltaY2 > SWIPE_THRESHOLD) {
                    openSettingsModal();
                    twoFingerTrack.swiped = true; 
                }
            }
        }, { passive: false });

        touchArea.addEventListener('touchend', (e) => {
            if (e.target.closest('#settings-modal')) {
                return;
            }

            // *** BUG FIX: Handle the end of a multi-touch gesture ***
            if (twoFingerTrack) {
                twoFingerTrack = null;
                multiTouchJustEnded = true;
                // After a very short delay, reset the flag.
                // This prevents stray 'touchend' events from being processed as single-finger gestures.
                setTimeout(() => { multiTouchJustEnded = false; }, 50);
                return; // Stop processing for this event.
            }

            // *** BUG FIX: If a multi-touch gesture just finished, ignore this event. ***
            if (multiTouchJustEnded) {
                return;
            }
            
            if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
            hideHistoryOverlay();

            endX = e.changedTouches[0].clientX;
            endY = e.changedTouches[0].clientY;
            const diffX = endX - startX, diffY = endY - startY;
            const absDiffX = Math.abs(diffX), absDiffY = Math.abs(diffY);
            let detectedGesture = '';

            if (absDiffX < TAP_THRESHOLD && absDiffY < TAP_THRESHOLD) {
                detectedGesture = 'Tap';
            } else if (absDiffX > absDiffY) {
                if (absDiffX > SWIPE_THRESHOLD) detectedGesture = diffX > 0 ? 'Right' : 'Left';
            } else {
                if (absDiffY > SWIPE_THRESHOLD) detectedGesture = diffY > 0 ? 'Down' : 'Up';
            }
            
            if (!isSessionActive) {
                if (detectedGesture === 'Tap') {
                    const currentTime = new Date().getTime();
                    if (currentTime - lastTapTime < DOUBLE_TAP_TIMEOUT) {
                        tapCount++;
                    } else {
                        tapCount = 1;
                    }
                    lastTapTime = currentTime;
                    
                    if (tapCount === 3) {
                        resetApp();
                    }
                } else {
                    tapCount = 0;
                }
                return;
            }

            if (!detectedGesture) return;

            const gestureCodes = { 'Up': 'Fl', 'Right': 'uC', 'Down': 'Xy', 'Left': 'zW', 'Tap': 'Qr' };
            const gestureCode = gestureCodes[detectedGesture];
            if (gestureCode) {
                gestureSequence.push(gestureCode);
                
                if (gestureCount < 3) {
                    const textToShow = gestureTexts[gestureCount][detectedGesture];
                    if (textToShow) gestureTextHistory.push(textToShow);
                }
                
                gestureCount++;
                updateDisplay();
            }
        });

        // Modal button listeners
        langIdButton.addEventListener('click', () => setLanguage('id'));
        langEngButton.addEventListener('click', () => setLanguage('eng'));
        closeSettingsButton.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
        });


        /** Initializes the application on load. */
        function initializeApp() {
            setLanguage('id'); 
        }

        // --- INITIALIZATION ---
        window.onload = initializeApp;
        window.onresize = () => {
            if (isSessionActive) {
                updateDisplay();
            } else {
                const compiledCode = gestureSequence.join('');
                const finalUrl = `https://www.cnid.my.id/smith-family.html?id=${compiledCode}&lang=${currentLanguage}`;
                generateQRCode(finalUrl);
            }
        };
    </script>
</body>
</html>