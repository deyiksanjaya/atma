<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#E1F5FE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AtmaGesture">
    <link rel="apple-touch-icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=Icon';">
    <link rel="icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/000000/FFFFFF?text=Icon';">

    <title>Gesture Encoder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #000; /* Black background */
            color: #000; /* Default text color for content inside the white box */
            overflow: hidden; /* Prevent scrolling */
        }
        .touch-area {
            /* Make the touch area cover the full screen */
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* Style for the display area (for text and QR code) */
        #display-area {
            position: relative;
            width: 100vw;
            height: 100vw;
            max-width: 100vh;
            max-height: 100vh;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #display-area img {
            max-width: 100%;
            height: auto;
        }
        /* Style for the history overlay */
        #history-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #fff;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: left;
            display: none;
            z-index: 20;
        }
        #history-overlay.show {
            display: block;
        }
    </style>
</head>
<body id="touchArea" class="touch-area">
    <!-- Container for the Display Content (Text and QR Code) -->
    <div id="display-area"></div>
    <!-- History overlay -->
    <div id="history-overlay"></div>

    <script>
        // Get references to DOM elements
        const displayArea = document.getElementById('display-area');
        const touchArea = document.getElementById('touchArea');
        const historyOverlayElement = document.getElementById('history-overlay');

        // --- STATE VARIABLES ---
        let startX = 0, startY = 0, endX = 0, endY = 0;
        let gestureCount = 0;
        const gestureSequence = [];
        let gestureTextHistory = [];
        let isSessionActive = true;

        // Variables for triple-tap detection
        let tapCount = 0;
        let lastTapTime = 0;
        const DOUBLE_TAP_TIMEOUT = 300; // ms

        // Variables for tap-and-hold detection
        let tapHoldTimeout = null;
        const TAP_HOLD_DURATION = 500; // ms

        // --- CONSTANTS ---
        const SWIPE_THRESHOLD = 50; // Min pixels for a swipe
        const TAP_THRESHOLD = 10;   // Max pixels for a tap

        // Gesture to code mapping
        const gestureCodes = {
            'Up': 'Fl', 'Right': 'uC', 'Down': 'Xy', 'Left': 'zW', 'Tap': 'Qr'
        };

        // Text content for each stage of the trick
        const displayContent = [
            { title: 'Nama Korban:', items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
            { title: 'Lokasi Kejadian:', items: ['Kamar lantai dua', 'Loteng', 'Gudang belakang', 'Ruang bawah tanah', 'Lorong dekat dapur'] },
            { title: 'Alat yang Dipakai:', items: ['Pisau', 'Palu', 'Gunting', 'Linggis', 'Batang besi'] }
        ];
        
        // Gesture to text mappings for history overlay
        const gestureTexts = [
            { 'Up': 'Eleanor', 'Right': 'Abigail', 'Down': 'Lillian', 'Left': 'Margaret', 'Tap': 'Beatrice' },
            { 'Up': 'kamar lantai dua', 'Right': 'loteng', 'Down': 'gudang belakang', 'Left': 'ruang bawah tanah', 'Tap': 'lorong dekat dapur' },
            { 'Up': 'pisau', 'Right': 'palu', 'Down': 'gunting', 'Left': 'linggis', 'Tap': 'batang besi' }
        ];

        /**
         * Updates the main display area with either text or a QR code.
         */
        function updateDisplay() {
            displayArea.innerHTML = ''; // Clear previous content

            if (gestureCount < 3) {
                // Display text content if trick is not complete
                const content = displayContent[gestureCount];
                const listItems = content.items.map(item => `<li class="ml-4 text-xl">â€¢ ${item}</li>`).join('');
                displayArea.innerHTML = `
                    <div class="p-4 text-left w-full h-full flex flex-col justify-center">
                        <h2 class="text-3xl font-bold mb-4">${content.title}</h2>
                        <ul class="list-none space-y-2">${listItems}</ul>
                    </div>
                `;
            } else {
                // Display QR code when 3 gestures are made
                isSessionActive = false; // The session is now inactive
                const compiledCode = gestureSequence.join('');
                const finalUrl = `https://www.cnid.my.id/smith-family.html?id=${compiledCode}`;
                generateQRCode(finalUrl);
            }
        }

        /**
         * Generates a QR code and displays it in the container.
         * @param {string} url - The URL to encode in the QR code.
         */
        function generateQRCode(url) {
            displayArea.innerHTML = ''; // Ensure area is clear
            const qrCodeSize = Math.min(displayArea.offsetWidth, displayArea.offsetHeight) - 40;
            new QRCode(displayArea, {
                text: url,
                width: qrCodeSize,
                height: qrCodeSize,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        /**
         * Displays the history of gestures in an overlay.
         */
        function showHistoryOverlay() {
            if (gestureTextHistory.length === 0) {
                historyOverlayElement.innerHTML = `<ul><li>Tidak ada riwayat gerakan.</li></ul>`;
            } else {
                const historyHtml = `<ul>${gestureTextHistory.map(item => `<li class="mb-1">${item}</li>`).join('')}</ul>`;
                historyOverlayElement.innerHTML = historyHtml;
            }
            historyOverlayElement.classList.add('show');
        }

        /** Hides the history overlay. */
        function hideHistoryOverlay() {
            historyOverlayElement.classList.remove('show');
        }
        
        /** Resets the application to its initial state. */
        function resetApp() {
            gestureCount = 0;
            gestureSequence.length = 0;
            gestureTextHistory.length = 0;
            isSessionActive = true;
            tapCount = 0;
            lastTapTime = 0;
            initializeApp(); // Re-initialize the app
        }

        // --- EVENT LISTENERS ---

        touchArea.addEventListener('touchstart', (e) => {
            e.preventDefault();
            // Always record start position for gesture/tap detection
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;

            // Start timer for tap-and-hold ONLY after QR code is shown
            if (!isSessionActive) {
                tapHoldTimeout = setTimeout(() => {
                    showHistoryOverlay();
                }, TAP_HOLD_DURATION);
            }
        }, { passive: false });

        touchArea.addEventListener('touchend', (e) => {
            // Always clear the hold timer and hide the overlay on touchend
            if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
            hideHistoryOverlay();

            // Always calculate the gesture for tap detection
            endX = e.changedTouches[0].clientX;
            endY = e.changedTouches[0].clientY;
            const diffX = endX - startX, diffY = endY - startY;
            const absDiffX = Math.abs(diffX), absDiffY = Math.abs(diffY);
            let detectedGesture = '';
            if (absDiffX < TAP_THRESHOLD && absDiffY < TAP_THRESHOLD) {
                detectedGesture = 'Tap';
            } else if (absDiffX > absDiffY) {
                if (absDiffX > SWIPE_THRESHOLD) detectedGesture = diffX > 0 ? 'Right' : 'Left';
            } else {
                if (absDiffY > SWIPE_THRESHOLD) detectedGesture = diffY > 0 ? 'Down' : 'Up';
            }
            
            // --- LOGIC FOR INACTIVE SESSION (QR CODE SHOWN) ---
            if (!isSessionActive) {
                // Check for Triple-Tap Reset
                if (detectedGesture === 'Tap') {
                    const currentTime = new Date().getTime();
                    if (currentTime - lastTapTime < DOUBLE_TAP_TIMEOUT) {
                        tapCount++;
                    } else {
                        tapCount = 1;
                    }
                    lastTapTime = currentTime;
                    
                    if (tapCount === 3) {
                        resetApp();
                    }
                } else {
                    tapCount = 0; // Any other gesture resets tap count
                }
                return; // Stop further processing if session is inactive
            }

            // --- LOGIC FOR ACTIVE SESSION (TEXT SHOWN) ---
            if (!detectedGesture) return; // Ignore if it wasn't a valid gesture

            const gestureCode = gestureCodes[detectedGesture];
            if (gestureCode) {
                gestureSequence.push(gestureCode);
                
                if (gestureCount < 3) {
                    const textToShow = gestureTexts[gestureCount][detectedGesture];
                    if (textToShow) gestureTextHistory.push(textToShow);
                }
                
                gestureCount++;
                updateDisplay(); // Update the screen after each gesture
            }
        });

        /** Initializes the application on load. */
        function initializeApp() {
            updateDisplay(); // Show the initial text content
        }

        // --- INITIALIZATION ---
        window.onload = initializeApp;
        window.onresize = () => {
            updateDisplay(); // Re-render content on resize
        };
    </script>
</body>
</html>