<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AtmaGesture">
    <link rel="apple-touch-icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=Icon';">
    <link rel="icon" href="https://support.apple.com/content/dam/edam/applecare/images/en_US/psp/psp_heroes/mini-hero-photos.image.large_2x.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/000000/FFFFFF?text=Icon';">

    <title>Gesture Encoder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            color: #000; /* Default text color */
            overflow: hidden; /* Prevent scrolling */
            position: fixed; /* Prevent pull-to-refresh */
            width: 100%;
            height: 100%;
            margin: 0;
        }
        /* Main container for the solid black background */
        #app-container {
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* The gallery frame, an overlay on the black background */
        #display-area {
            position: relative;
            width: 100vw;
            height: 100vw;
            max-height: 100vh;
            box-sizing: border-box;
            overflow: hidden; /* Crucial for gallery effect */
        }
        #slide-container {
            height: 100%;
            display: flex;
            transition: transform 0.4s ease-in-out;
            /* Use gap to create space BETWEEN slides */
            gap: 20px;
        }
        /* The transparent container for each photo */
        .slide {
            height: 100%;
            width: 100vw;
            flex-shrink: 0; /* Prevent slides from shrinking */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* The actual white "photo" content */
        .slide-content {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px; /* Inner padding for text */
            box-sizing: border-box;
        }
        /* Style for the history overlay */
        #history-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #fff;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: left;
            display: none;
            z-index: 20;
        }
        #history-overlay.show {
            display: block;
        }
    </style>
</head>
<body id="touchArea">
    <!-- Main container with solid black background -->
    <div id="app-container">
        <!-- The gallery frame, centered on the black background -->
        <div id="display-area">
            <div id="slide-container"></div>
        </div>
    </div>

    <!-- History overlay -->
    <div id="history-overlay"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm text-black">
            <h2 id="settings-title" class="text-2xl font-bold mb-4"></h2>
            <div class="mb-4">
                <label id="language-label" class="block mb-2 font-medium"></label>
                <div class="flex space-x-2">
                    <button id="lang-id" class="flex-1 p-2 rounded-md border-2"></button>
                    <button id="lang-eng" class="flex-1 p-2 rounded-md border-2"></button>
                </div>
            </div>
            <button id="close-settings" class="w-full bg-gray-500 text-white p-2 rounded-md mt-4"></button>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT REFERENCES ---
        const displayArea = document.getElementById('display-area');
        const slideContainer = document.getElementById('slide-container');
        const touchArea = document.getElementById('touchArea');
        const historyOverlayElement = document.getElementById('history-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const settingsTitle = document.getElementById('settings-title');
        const languageLabel = document.getElementById('language-label');
        const langIdButton = document.getElementById('lang-id');
        const langEngButton = document.getElementById('lang-eng');
        const closeSettingsButton = document.getElementById('close-settings');

        // --- LANGUAGE & TRANSLATIONS ---
        const translations = {
            id: {
                victimName: 'Nama Korban:',
                crimeScene: 'Lokasi Kejadian:',
                weapon: 'Alat yang Dipakai:',
                noHistory: 'Tidak ada riwayat gerakan.',
                settingsTitle: 'Pengaturan',
                languageLabel: 'Bahasa:',
                closeButton: 'Tutup',
                langId: 'Indonesia',
                langEng: 'English'
            },
            eng: {
                victimName: "Victim's Name:",
                crimeScene: 'Crime Scene:',
                weapon: 'Weapon Used:',
                noHistory: 'No gesture history.',
                settingsTitle: 'Settings',
                languageLabel: 'Language:',
                closeButton: 'Close',
                langId: 'Indonesia',
                langEng: 'English'
            }
        };

        const displayContent = {
            id: [
                { title: translations.id.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.id.crimeScene, items: ['Kamar lantai dua', 'Loteng', 'Gudang belakang', 'Ruang bawah tanah', 'Lorong dekat dapur'] },
                { title: translations.id.weapon, items: ['Pisau', 'Palu', 'Gunting', 'Linggis', 'Batang besi'] }
            ],
            eng: [
                { title: translations.eng.victimName, items: ['Eleanor', 'Abigail', 'Lillian', 'Margaret', 'Beatrice'] },
                { title: translations.eng.crimeScene, items: ['Second floor room', 'Attic', 'Back warehouse', 'Basement', 'Hallway near kitchen'] },
                { title: translations.eng.weapon, items: ['Knife', 'Hammer', 'Scissors', 'Crowbar', 'Iron rod'] }
            ]
        };
        
        const gestureTexts = [
            { 'Up': 'Eleanor', 'Right': 'Abigail', 'Down': 'Lillian', 'Left': 'Margaret', 'Tap': 'Beatrice' },
            { 'Up': 'kamar lantai dua', 'Right': 'loteng', 'Down': 'gudang belakang', 'Left': 'ruang bawah tanah', 'Tap': 'lorong dekat dapur' },
            { 'Up': 'pisau', 'Right': 'palu', 'Down': 'gunting', 'Left': 'linggis', 'Tap': 'batang besi' }
        ];

        // --- STATE VARIABLES ---
        let startX = 0, startY = 0;
        let gestureCount = 0;
        let currentSlideIndex = 0;
        const gestureSequence = [];
        let gestureTextHistory = [];
        let isSessionActive = true;
        let tapCount = 0;
        let lastTapTime = 0;
        let tapHoldTimeout = null;
        let currentLanguage = 'id';
        let twoFingerTrack = null;
        let multiTouchJustEnded = false;
        let startArea = null;

        // --- CONSTANTS ---
        const SWIPE_THRESHOLD = 50;
        const TAP_THRESHOLD = 10;
        const DOUBLE_TAP_TIMEOUT = 300;
        const TAP_HOLD_DURATION = 500;
        const TOTAL_SLIDES = 4; // 3 questions + 1 QR code
        const SLIDE_GAP = 20; // The gap in pixels between slides
        
        // --- MAPPINGS for Grid Logic ---
        const gridToGesture = { 'a': 'A', 'b': 'B', 'c': 'C', 'd': 'D', 'e': 'E' };
        const gestureToCode = { 'A': 'Fl', 'B': 'uC', 'C': 'zW', 'D': 'Xy', 'E': 'Qr' };
        const gestureToTextKey = { 'A': 'Up', 'B': 'Right', 'C': 'Left', 'D': 'Down', 'E': 'Tap' };

        // --- CORE FUNCTIONS ---

        function setLanguage(lang) {
            currentLanguage = lang;
            const t = translations[currentLanguage];
            settingsTitle.textContent = t.settingsTitle;
            languageLabel.textContent = t.languageLabel;
            closeSettingsButton.textContent = t.closeButton;
            langIdButton.textContent = t.langId;
            langEngButton.textContent = t.langEng;
            if (lang === 'id') {
                langIdButton.className = 'flex-1 p-2 rounded-md border-2 border-blue-500 bg-blue-500 text-white';
                langEngButton.className = 'flex-1 p-2 rounded-md border-2 border-gray-300 bg-white text-black';
            } else {
                langIdButton.className = 'flex-1 p-2 rounded-md border-2 border-gray-300 bg-white text-black';
                langEngButton.className = 'flex-1 p-2 rounded-md border-2 border-blue-500 bg-blue-500 text-white';
            }
            resetApp();
        }

        function createSlide(slideIndex) {
            const slide = document.createElement('div');
            slide.className = 'slide';
            
            const slideContent = document.createElement('div');
            slideContent.className = 'slide-content';

            if (slideIndex < 3) { // Question slides
                const contentData = displayContent[currentLanguage][slideIndex];
                const listItems = contentData.items.map(item => `<li class="ml-4 text-xl">• ${item}</li>`).join('');
                slideContent.innerHTML = `
                    <div class="text-left w-full h-full flex flex-col justify-center">
                        <h2 class="text-3xl font-bold mb-4">${contentData.title}</h2>
                        <ul class="list-none space-y-2">${listItems}</ul>
                    </div>
                `;
            } else { // QR Code slide - it will be populated later
                slideContent.innerHTML = ''; // Start empty
            }
            slide.appendChild(slideContent);
            return slide;
        }
        
        function animateToSlide(slideIndex) {
            const slideWidth = displayArea.getBoundingClientRect().width;
            const totalTranslation = (slideWidth * slideIndex) + (SLIDE_GAP * slideIndex);
            slideContainer.style.transform = `translateX(-${totalTranslation}px)`;
            currentSlideIndex = slideIndex;
        }

        function setupInitialView() {
            slideContainer.innerHTML = '';
            for(let i = 0; i < TOTAL_SLIDES; i++) {
                const slide = createSlide(i);
                slideContainer.appendChild(slide);
            }
            animateToSlide(0);
        }
        
        function resetApp() {
            gestureCount = 0;
            currentSlideIndex = 0;
            gestureSequence.length = 0;
            gestureTextHistory.length = 0;
            isSessionActive = true;
            tapCount = 0;
            lastTapTime = 0;
            setupInitialView();
        }
        
        function showHistoryOverlay() {
            if (gestureTextHistory.length === 0) {
                historyOverlayElement.innerHTML = `<ul><li>${translations[currentLanguage].noHistory}</li></ul>`;
            } else {
                const historyHtml = `<ul>${gestureTextHistory.map(item => `<li class="mb-1">${item}</li>`).join('')}</ul>`;
                historyOverlayElement.innerHTML = historyHtml;
            }
            historyOverlayElement.classList.add('show');
        }

        function hideHistoryOverlay() {
            historyOverlayElement.classList.remove('show');
        }

        // --- GRID FUNCTIONS ---
        function getGridArea(clientX, clientY) {
            const rect = displayArea.getBoundingClientRect();
            if (clientX < rect.left || clientX > rect.right || clientY < rect.top || clientY > rect.bottom) return null;
            const localX = clientX - rect.left;
            const localY = clientY - rect.top;
            const centerXStart = rect.width * 0.25, centerXEnd = rect.width * 0.75;
            const centerYStart = rect.height * 0.25, centerYEnd = rect.height * 0.75;
            if (localX > centerXStart && localX < centerXEnd && localY > centerYStart && localY < centerYEnd) return 'e';
            const midX = rect.width / 2, midY = rect.height / 2;
            if (localX < midX && localY < midY) return 'a';
            if (localX >= midX && localY < midY) return 'b';
            if (localX < midX && localY >= midY) return 'c';
            if (localX >= midX && localY >= midY) return 'd';
            return null;
        }


        // --- MODAL FUNCTIONS ---
        function openSettingsModal() { settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); }

        // --- EVENT LISTENERS ---

        touchArea.addEventListener('touchstart', (e) => {
            if (e.target.closest('#settings-modal')) return;
            e.preventDefault();
            
            if (e.touches.length === 2) {
                twoFingerTrack = { startY1: e.touches[0].clientY, startY2: e.touches[1].clientY, swiped: false };
                return; 
            }

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startArea = getGridArea(startX, startY);

            // Set a timeout to show history only if the session is over
            if (!isSessionActive) {
                tapHoldTimeout = setTimeout(showHistoryOverlay, TAP_HOLD_DURATION);
            }

        }, { passive: false });

        touchArea.addEventListener('touchmove', (e) => {
            if (e.target.closest('#settings-modal')) return;
            e.preventDefault();
            if (twoFingerTrack && e.touches.length === 2 && !twoFingerTrack.swiped) {
                const deltaY1 = e.touches[0].clientY - twoFingerTrack.startY1;
                const deltaY2 = e.touches[1].clientY - twoFingerTrack.startY2;
                if (deltaY1 > SWIPE_THRESHOLD && deltaY2 > SWIPE_THRESHOLD) {
                    openSettingsModal();
                    twoFingerTrack.swiped = true; 
                }
            }
        }, { passive: false });

        touchArea.addEventListener('touchend', (e) => {
            if (e.target.closest('#settings-modal')) return;

            if (twoFingerTrack) {
                twoFingerTrack = null;
                multiTouchJustEnded = true;
                setTimeout(() => { multiTouchJustEnded = false; }, 50);
                return;
            }

            if (multiTouchJustEnded) return;

            // Always clear the tap-hold timeout and hide the overlay on touchend
            if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
            hideHistoryOverlay();
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = endX - startX;
            const absDiffX = Math.abs(diffX);
            const absDiffY = Math.abs(endY - startY);

            // --- GALLERY NAVIGATION LOGIC (POST-SESSION) ---
            if (!isSessionActive) {
                // Handle triple tap to reset
                const isTap = absDiffX < TAP_THRESHOLD && absDiffY < TAP_THRESHOLD;
                if (isTap) {
                    const currentTime = new Date().getTime();
                    tapCount = (currentTime - lastTapTime < DOUBLE_TAP_TIMEOUT) ? tapCount + 1 : 1;
                    lastTapTime = currentTime;
                    if (tapCount === 3) resetApp();
                    return;
                }
                
                // Handle gallery swipe
                if (absDiffX > SWIPE_THRESHOLD && absDiffX > absDiffY) {
                    if (diffX > 0 && currentSlideIndex > 0) { // Swipe Right
                        animateToSlide(currentSlideIndex - 1);
                    } else if (diffX < 0 && currentSlideIndex < TOTAL_SLIDES - 1) { // Swipe Left
                        animateToSlide(currentSlideIndex + 1);
                    }
                }
                return;
            }

            // --- ACTIVE SESSION GESTURE LOGIC ---
            let detectedGesture = '';
            if (startArea && diffX < 0 && absDiffX > SWIPE_THRESHOLD && absDiffX > absDiffY) {
                detectedGesture = gridToGesture[startArea];
            }
            startArea = null;

            if (!detectedGesture) return;

            const gestureCode = gestureToCode[detectedGesture];
            if (gestureCode) {
                gestureSequence.push(gestureCode);
                
                const textKey = gestureToTextKey[detectedGesture];
                const textToShow = gestureTexts[gestureCount][textKey];
                if (textToShow) gestureTextHistory.push(textToShow);
                
                gestureCount++;

                // Animate to the next slide
                animateToSlide(gestureCount);
                
                // Check if the session should end
                if (gestureCount >= 3) {
                    isSessionActive = false;
                    const lastSlideContent = slideContainer.children[3].querySelector('.slide-content');
                    lastSlideContent.innerHTML = ''; // Clear placeholder content
                    const finalUrl = `https://www.cnid.my.id/smith-family.html?id=${gestureSequence.join('')}&lang=${currentLanguage}`;
                    const qrCodeSize = Math.min(lastSlideContent.offsetWidth, lastSlideContent.offsetHeight) * 0.9;
                     new QRCode(lastSlideContent, {
                        text: finalUrl,
                        width: qrCodeSize,
                        height: qrCodeSize,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }
        });

        // Modal button listeners
        langIdButton.addEventListener('click', () => setLanguage('id'));
        langEngButton.addEventListener('click', () => setLanguage('eng'));
        closeSettingsButton.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        // --- INITIALIZATION ---
        window.onload = () => {
            setLanguage('id');
        };
        window.onresize = () => {
            // Re-align slide on resize to maintain correct position
            animateToSlide(currentSlideIndex);
        };
    </script>
</body>
</html>