<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to prevent zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aplikasi Kotak Kuadran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRious library for QR Code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body {
            /* Set background to black and use Inter font */
            background-color: #000;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Changed to column to stack main-container and output */
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            margin: 0;
            overflow: hidden; /* Prevent scrollbars if content slightly overflows */
            /* Prevent text highlighting/selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            user-select: none; /* Standard */
        }

        /* Custom style for the main container to ensure it's a horizontal rectangle */
        .main-container {
            /* Responsive width, capped at 900px */
            width: min(90vw, 900px); 
            /* Height will automatically adjust to maintain 9:4 aspect ratio */
            aspect-ratio: 9 / 4; /* Fixed aspect ratio matching 900x400 images */
            height: auto; /* Ensure height is not overriding aspect-ratio */

            position: relative; /* For absolute positioning of the center box */
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2x2 grid for quadrants */
            grid-template-rows: repeat(2, 1fr);
            gap: 4px; /* Small gap between quadrants */
            background-color: rgba(51, 51, 51, 0.5); /* Semi-transparent dark gray for the gaps/borders */
            border-radius: 12px; /* Rounded corners for the main container */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); /* Subtle neon glow */
            z-index: 1; /* Ensure main-container is above the full-page background images */
        }

        /* Container for background images, now positioned fixed to the viewport */
        .background-image-viewer {
            position: fixed; /* Fixed to viewport */
            top: 0;
            left: 0;
            width: 100vw; /* Take full viewport width */
            height: 100vh; /* Take full viewport height */
            overflow: hidden; /* Hide overflowing images */
            z-index: -1; /* Send to back, behind everything else */
        }

        .image-slider {
            display: flex; /* Arrange images horizontally */
            width: 400vw; /* 4 images * 100vw each (3 placeholders + 1 QR) */
            height: 100vh; /* Take full viewport height */
            transition: transform 0.8s ease-in-out; /* Smooth sliding transition */
        }

        .image-slider img {
            width: 100vw; /* Each image takes 100vw of the slider's segment */
            height: 100vh; /* Each image takes 100vh of the slider's segment */
            object-fit: contain; /* Show full image, with letterboxing if aspect ratio doesn't match */
            flex-shrink: 0; /* Prevent images from shrinking */
        }

        .quadrant-box {
            display: flex;
            justify-content: center;
            align-items: center;
            /* Made background transparent/colorless */
            background-color: rgba(26, 26, 26, 0.2); /* Very subtle dark transparent tint */
            color: #00ffff; /* Neon cyan text */
            font-size: 3rem; /* Large font size for labels */
            font-weight: bold;
            border-radius: 8px; /* Rounded corners for individual boxes */
            transition: background-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
            z-index: 2; /* Ensure boxes are above background images */
        }

        .quadrant-box:hover {
            background-color: #00ffff; /* Invert colors on hover */
            color: #1a1a1a;
            transform: scale(1.05); /* Slightly enlarge on hover */
        }

        .center-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center the box precisely */
            width: 30%; /* Size relative to the main container */
            height: 30%;
            /* Made background transparent/colorless */
            background-color: rgba(26, 26, 26, 0.2); /* Very subtle dark transparent tint */
            color: #ff00ff; /* Neon magenta for center */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem; /* Even larger font for center label */
            font-weight: bold;
            /* Changed border-radius to make it a rectangle */
            border-radius: 8px; /* Matching the quadrant boxes for a rectangular shape */
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.7); /* Stronger neon glow */
            z-index: 2; /* Ensure it's above quadrants and background images */
            transition: background-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }

        .center-box:hover {
            background-color: #1a1a1a; /* Invert colors on hover */
            color: #ff00ff;
            transform: translate(-50%, -50%) scale(1.1); /* Enlarge more on hover */
        }

        .toggle-button {
            position: fixed; /* Position fixed relative to the viewport */
            bottom: 20px; /* 20px from the bottom */
            right: 20px; /* 20px from the right */
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            z-index: 100; /* Ensure it's above other content */
        }

        .toggle-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Background Image Carousel, now OUTSIDE main-container -->
    <div class="background-image-viewer">
        <div class="image-slider" id="imageSlider">
            <!-- Updated placeholder image sizes to landscape orientation (1920x1080) -->
            <img src="https://placehold.co/1920x1080/0000FF/FFFFFF?text=Gambar+1" alt="Gambar Latar Belakang 1">
            <img src="https://placehold.co/1920x1080/FF0000/FFFFFF?text=Gambar+2" alt="Gambar Latar Belakang 2">
            <img src="https://placehold.co/1920x1080/00FF00/FFFFFF?text=Gambar+3" alt="Gambar Latar Belakang 3">
            <!-- Placeholder for QR Code image (4th image) -->
            <img id="qrCodeImage" src="https://placehold.co/1920x1080/000000/FFFFFF?text=QR+Code+Akan+Muncul+Di+Sini" alt="QR Code Placeholder">
        </div>
    </div>

    <div class="main-container" id="mainContainer">
        <!-- Quadrant A (Top-Left) -->
        <div class="quadrant-box" id="boxA">A</div>
        <!-- Quadrant B (Top-Right) -->
        <div class="quadrant-box" id="boxB">B</div>
        <!-- Quadrant C (Bottom-Left) -->
        <div class="quadrant-box" id="boxC">C</div>
        <!-- Quadrant D (Bottom-Right) -->
        <div class="quadrant-box" id="boxD">D</div>
        
        <!-- Center Box E -->
        <div class="center-box" id="boxE">E</div>
    </div>

    <!-- Output display for encoded value -->
    <div id="swipeOutput" class="text-center text-white text-xl mt-4"></div>

    <!-- Toggle Button -->
    <button id="toggleInputButton" class="toggle-button">Sembunyikan Input</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.querySelector('.main-container');
            const boxes = document.querySelectorAll('.quadrant-box, .center-box');
            const swipeOutput = document.getElementById('swipeOutput');
            const imageSlider = document.getElementById('imageSlider');
            const qrCodeImage = document.getElementById('qrCodeImage'); // Get the QR code image element
            const images = document.querySelectorAll('.image-slider img'); // Re-select all images including QR placeholder
            const toggleInputButton = document.getElementById('toggleInputButton'); // Get the toggle button

            let totalImages = images.length; // Will be 4 initially
            let currentImageIndex = 0; // Ensures Gambar 1 is shown initially

            let inputSequence = []; // Array to store the sequence of inputs (a, b, c, d, e)
            const MAX_INPUT_LENGTH = 3; // Number of inputs required before generating QR

            // Define the encoding map, matching the one in homepage-cnn.html
            const encodingMap = {
                'a': 'Fl',
                'b': 'uC',
                'c': 'Xy',
                'd': 'zW',
                'e': 'Qr'
            };

            // Function to translate raw input characters into the secret ID format
            function translateInputForSecretId(input) {
                let translated = '';
                const maxLength = 3; 
                
                const encodingMapInternal = { // Use a local copy or reference the global one
                    'a': 'Fl',
                    'b': 'uC',
                    'c': 'Xy',
                    'd': 'zW',
                    'e': 'Qr'
                };

                for (let i = 0; i < input.length && i < maxLength; i++) {
                    const char = input[i].toLowerCase();
                    if (encodingMapInternal[char]) { 
                        translated += encodingMapInternal[char];
                    } else {
                        translated += encodingMapInternal['a']; // Default to 'Fl'
                    }
                }
                
                while (translated.length < maxLength * 2) { 
                    translated += encodingMapInternal['a']; 
                }
                return translated;
            }

            // Function to generate QR code and update the 4th image slot
            function generateQRCodeImage(url) {
                const tempCanvas = document.createElement('canvas');
                const qrSize = 500; // A larger square size for better resolution
                tempCanvas.width = qrSize; 
                tempCanvas.height = qrSize;

                new QRious({
                    element: tempCanvas,
                    value: url,
                    size: qrSize, // Size of the QR code modules within the canvas
                    padding: 40 // Increased padding for a better quiet zone (e.g., 40 pixels)
                });

                qrCodeImage.src = tempCanvas.toDataURL(); // Set the src of the 4th image
                qrCodeImage.alt = "Generated QR Code";
            }

            // Variables for swipe detection
            let touchStartX = 0;
            let touchStartY = 0;
            let isSwiping = false; // Flag to indicate if a swipe (not just a drag) is occurring
            // Reduced SWIPE_THRESHOLD_X for faster detection
            const SWIPE_THRESHOLD_X = 20; // Minimum horizontal pixels for a swipe
            // Increased MAX_VERTICAL_DEVIATION for more lenient swipe detection
            const MAX_VERTICAL_DEVIATION = 50; // Maximum vertical deviation for a horizontal swipe

            // Function to slide the background image to a specific index
            function slideImage(index) {
                imageSlider.style.transition = 'transform 0.8s ease-in-out'; // Enable smooth transition
                imageSlider.style.transform = `translateX(-${index * 100}vw)`;
                currentImageIndex = index; // Update the global index
            }

            // Handle input (only 'a' from left swipe now)
            function handleInput(char) {
                if (inputSequence.length < MAX_INPUT_LENGTH) {
                    inputSequence.push(char);
                    swipeOutput.textContent = `Input: ${inputSequence.join(', ').toUpperCase()}`;
                    
                    // Advance to the next placeholder image (Gambar 1 -> Gambar 2 -> Gambar 3)
                    // Only advance if we are still collecting inputs for the code
                    if (inputSequence.length <= MAX_INPUT_LENGTH) { // Check if it's the 1st, 2nd, or 3rd input
                        currentImageIndex = (currentImageIndex + 1) % (totalImages - 1); // Cycle through 0, 1, 2
                        slideImage(currentImageIndex);
                    }
                }

                if (inputSequence.length === MAX_INPUT_LENGTH) {
                    const rawCode = inputSequence.join('');
                    const encodedCode = translateInputForSecretId(rawCode);
                    const qrLink = `https://atmamagic.vercel.app/smith-family.html?id=${encodedCode}`;
                    
                    swipeOutput.textContent = `Kode Lengkap: ${encodedCode} (QR Dibuat!)`;
                    console.log(`Kode gabungan: ${rawCode}, Kode terenkripsi: ${encodedCode}`);
                    console.log(`Link QR: ${qrLink}`);

                    generateQRCodeImage(qrLink); // This only generates the image data
                    
                    // Set currentImageIndex directly to the QR code image index (3)
                    currentImageIndex = totalImages - 1; // totalImages is 4, so index 3
                    slideImage(currentImageIndex); // Slide to the QR code image
                    
                    inputSequence = []; // Reset sequence after QR generation
                }
            }

            // Add touch event listeners to the main container (for swipe detection and dragging)
            mainContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false; // Reset swipe flag
                imageSlider.style.transition = 'none'; // Disable transition during drag
            });

            mainContainer.addEventListener('touchmove', (e) => {
                const touchCurrentX = e.touches[0].clientX;
                const touchCurrentY = e.touches[0].clientY;

                const deltaX = touchCurrentX - touchStartX;
                const deltaY = Math.abs(touchCurrentY - touchStartY);

                // If horizontal movement is significant and vertical movement is small, it's a drag
                if (Math.abs(deltaX) > 5 || deltaY > 5) { // Small threshold to detect any movement
                    isSwiping = true; // Mark as potential swipe/drag
                }

                // Only allow horizontal drag if vertical deviation is small
                if (deltaY < MAX_VERTICAL_DEVIATION) {
                    e.preventDefault(); // Prevent scrolling while dragging horizontally
                    // Calculate the new translateX based on drag
                    const currentOffsetPx = currentImageIndex * window.innerWidth;
                    const newOffsetPx = currentOffsetPx - deltaX;
                    imageSlider.style.transform = `translateX(-${newOffsetPx}px)`;
                }
            });

            mainContainer.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;

                const diffX = touchStartX - touchEndX; // Positive for left swipe, negative for right swipe
                const diffY = Math.abs(touchStartY - touchEndY);

                // Re-enable transition for snapping
                imageSlider.style.transition = 'transform 0.8s ease-in-out';

                // Check for a significant horizontal swipe
                if (Math.abs(diffX) > SWIPE_THRESHOLD_X && diffY < MAX_VERTICAL_DEVIATION) {
                    if (diffX > 0) { // Swiped left
                        // This swipe is an input for 'a'
                        handleInput('a'); 
                    } else { // Swiped right
                        // Swiping right does not count as an input for the code, but navigates images
                        if (inputSequence.length < MAX_INPUT_LENGTH) {
                            currentImageIndex = (currentImageIndex - 1 + (totalImages - 1)) % (totalImages - 1); // Cycle through 0, 1, 2
                            slideImage(currentImageIndex);
                        } else {
                            currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages; // Cycle through all 4
                            slideImage(currentImageIndex);
                        }
                    }
                } else {
                    // Not a significant swipe, snap back to the original image
                    slideImage(currentImageIndex);
                }
                isSwiping = false; // Reset swipe flag
            });

            // Remove click event listeners from individual boxes as per request
            // boxes.forEach(box => {
            //     box.addEventListener('click', (e) => {
            //         // This logic is now removed. All inputs are handled by swipe.
            //     });
            // });

            // Toggle input visibility
            toggleInputButton.addEventListener('click', () => {
                if (mainContainer.style.display === 'none') {
                    mainContainer.style.display = 'grid'; // Show the grid
                    toggleInputButton.textContent = 'Sembunyikan Input';
                } else {
                    mainContainer.style.display = 'none'; // Hide the grid
                    toggleInputButton.textContent = 'Tampilkan Input';
                }
            });

            // Initial display of Gambar 1
            slideImage(currentImageIndex);
        });
    </script>
</body>
</html>
